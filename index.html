<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gaji Tim</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --bg:#f3f4f6;
  --card:#fff;
  --primary:#2563eb;
  --muted:#6b7280;
  --border:#e5e7eb;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Arial;
  background:var(--bg);
  padding:12px;
}
h2,h3,h4{margin:6px 0}

/* CARD */
.card{
  background:var(--card);
  padding:14px;
  border-radius:12px;
  margin-bottom:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.06);
}

/* BUTTON */
button{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button.secondary{background:var(--muted)}
button:disabled{opacity:.6;cursor:not-allowed}

/* FORM */
label{
  font-size:13px;
  font-weight:600;
  margin-top:8px;
  display:block;
}
input,select{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border);
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
@media(max-width:600px){
  .grid{grid-template-columns:1fr}
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:6px 8px;   /* tinggi baris lebih rapat */
  font-size:12px;    /* font dikecilkan */
  line-height:1.2;
}

th{background:#f9fafb;text-align:center}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}
.modal.active{display:flex}
.box{
  background:#fff;
  padding:14px;
  border-radius:14px;
  width:95%;
  max-width:420px;
  max-height:90vh;
  overflow:auto;
}

/* SLIP */
#slip table{
  width:100%;
  border-collapse:collapse;
  font-size:11px;   /* kecil & elegan */
  line-height:1.2;
}

#slip td{
  padding:2px 4px;  /* super rapat */
  vertical-align:top;
}

hr{border:0;border-top:1px solid #000}
</style>
</head>

<body>

<!-- HEADER -->
<div class="card">
  <h2>Gaji Tim</h2>
  <div class="grid">
    <select id="filter">
      <option value="">Semua Periode</option>
    </select>
    <button onclick="openInput()">+ Input Gaji</button>
  </div>
</div>

<!-- TABLE DATA -->
<div class="card">
<table>
<thead>
<tr>
  <th>Tanggal</th>
  <th>Nama Tim</th>
  <th>Jabatan</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- INPUT MODAL -->
<div class="modal" id="inputM">
<div class="box">
<h3>Input Gaji</h3>

<label>Tanggal</label>
<input type="date" id="tanggal">

<label>Periode</label>
<input id="periode" placeholder="Januari">

<label>Jabatan</label>
<select id="jabatan"></select>

<label>Nama Tim</label>
<select id="nama_tim"></select>

<div class="grid">
  <div><label>Gaji Pokok</label><input type="number" id="gaji"></div>
  <div><label>Uang Makan</label><input type="number" id="makan"></div>
</div>

<label>Transport</label>
<input type="number" id="transport">

<h4>Bonus</h4>
<div id="bonusBox"></div>
<button onclick="addBonus()">+ Bonus</button>

<h4>Potongan</h4>
<div id="potBox"></div>
<button onclick="addPot()">+ Potongan</button>

<br><br>
<button id="btnSimpan" onclick="simpan()">Simpan</button>
<button class="secondary" onclick="closeInput()">Tutup</button>
</div>
</div>

<!-- PREVIEW -->
<div class="modal" id="prevM">
<div class="box">
<div id="slip"></div>
<br>
<button onclick="download()">Unduh JPEG</button>
<button class="secondary" onclick="closePrev()">Tutup</button>
</div>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxXD3RqaTs_ZsR79m5RAyhsHls81ELyUV-aTbbWYDKOso0ArLTspQb7vC5EvgTuVPTdPQ/exec";
const TTD_URL = "https://upload.wikimedia.org/wikipedia/commons/0/04/Tanda_tangan_bapak.png";

/* DATA */
const DATA_TIM = {
  Admin: ["Sila","Devita","Lia","Firda","Intan","Fahim","Isti"],
  Editor: ["Ainul","Novian","Rosad","Budi"],
  Mahar:[""]
};

let DATA=[], CUR=null;
let IS_SAVING=false;

/* FORMAT TANGGAL */
function fmt(v){
  const d=new Date(v);
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
}

/* MODAL */
const openInput=()=>inputM.classList.add("active");
const closeInput=()=>inputM.classList.remove("active");
const openPrev=()=>prevM.classList.add("active");
const closePrev=()=>prevM.classList.remove("active");

/* INIT JABATAN */
jabatan.innerHTML='<option value="">Pilih Jabatan</option>'+
  Object.keys(DATA_TIM).map(j=>`<option>${j}</option>`).join("");

jabatan.onchange=()=>{
  nama_tim.innerHTML = DATA_TIM[jabatan.value]
    ? DATA_TIM[jabatan.value].map(t=>`<option>${t}</option>`).join("")
    : "";
};

/* BONUS & POTONGAN */
function addBonus(){
  bonusBox.insertAdjacentHTML("beforeend",
  `<div class="grid">
    <input placeholder="Keterangan">
    <input type="number" placeholder="Nilai">
  </div>`);
}
function addPot(){
  potBox.insertAdjacentHTML("beforeend",
  `<div class="grid">
    <input placeholder="Keterangan">
    <input type="number" placeholder="Nilai">
  </div>`);
}

/* LOAD */
fetch(API_URL).then(r=>r.json()).then(d=>{
  DATA=d; render(DATA);
  const p=[...new Set(d.map(x=>x.periode))];
  filter.innerHTML='<option value="">Semua Periode</option>'+p.map(x=>`<option>${x}</option>`).join("");
});

/* FILTER */
filter.onchange=()=>render(filter.value?DATA.filter(d=>d.periode===filter.value):DATA);

/* RENDER */
function render(arr){
  tbody.innerHTML="";
  arr.forEach(d=>{
    tbody.innerHTML+=`
    <tr>
      <td>${fmt(d.tanggal)}</td>
      <td>${d.nama_tim}</td>
      <td>${d.jabatan}</td>
      <td><button onclick='preview(${JSON.stringify(d)})'>Preview</button></td>
    </tr>`;
  });
}

/* SIMPAN (ANTI SPAM) */
function simpan(){
  if(IS_SAVING) return;
  IS_SAVING=true;

  btnSimpan.disabled=true;
  btnSimpan.textContent="Menyimpan...";

  const bonus=[...bonusBox.children].map(b=>({
    ket:b.children[0].value,
    nilai:+b.children[1].value||0
  }));
  const potongan=[...potBox.children].map(p=>({
    ket:p.children[0].value,
    nilai:+p.children[1].value||0
  }));

  const total =
    +gaji.value + +makan.value + +transport.value +
    bonus.reduce((a,b)=>a+b.nilai,0) -
    potongan.reduce((a,b)=>a+b.nilai,0);

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      tanggal:tanggal.value,
      periode:periode.value,
      jabatan:jabatan.value,
      nama_tim:nama_tim.value,
      gaji_pokok:+gaji.value,
      uang_makan:+makan.value,
      transport:+transport.value,
      bonus,potongan,total
    })
  })
  .then(r=>r.json())
  .then(()=>{
    closeInput();
    return fetch(API_URL).then(r=>r.json());
  })
  .then(d=>{
    DATA=d;
    render(DATA);
  })
  .finally(()=>{
    IS_SAVING=false;
    btnSimpan.disabled=false;
    btnSimpan.textContent="Simpan";
  });
}

/* PREVIEW */
function preview(d){
  CUR=d;
  slip.innerHTML=`
<b style="display:block;text-align:center">SLIP GAJI TIM</b>
<b style="display:block;text-align:center">OFFICIAL CERITA CINTA</b>
<b style="display:block;text-align:center">Dsn. Temboro Ds. Plaosan, Kec. Wates - Kediri</b>
<hr>

<table style="font-size:12px">
<tr><td>Nama</td><td>: ${d.nama_tim}</td><td>Tanggal</td><td>: ${fmt(d.tanggal)}</td></tr>
<tr><td>Jabatan</td><td>: ${d.jabatan}</td><td>Periode</td><td>: ${d.periode}</td></tr>
</table>

<hr>

<table style="width:100%">
<tr>
<td width="50%" valign="top">
<b><u>A. Pendapatan</u></b>
<table>
<tr><td>Gaji Pokok</td><td align="right">Rp ${d.gaji_pokok.toLocaleString("id-ID")}</td></tr>
<tr><td>Uang Makan</td><td align="right">Rp ${d.uang_makan.toLocaleString("id-ID")}</td></tr>
<tr><td>Transport</td><td align="right">Rp ${d.transport.toLocaleString("id-ID")}</td></tr>
${d.bonus.map(b=>`
<tr><td>${b.ket}</td><td align="right">Rp ${b.nilai.toLocaleString("id-ID")}</td></tr>
`).join("")}
</table>
</td>

<td width="50%" valign="top">
<b><u>B. Pemotongan</u></b>
<table>
${d.potongan.length
? d.potongan.map(p=>`
<tr><td>${p.ket}</td><td align="right">-Rp ${p.nilai.toLocaleString("id-ID")}</td></tr>
`).join("")
: `<tr><td colspan="2">-</td></tr>`}
</table>
</td>
</tr>
</table>

<hr>
<h5><b>TOTAL (A - B): Rp ${d.total.toLocaleString("id-ID")}</b></h5>
<h5><b>TAKE HOME PAY (v)</b></h5>
<table style="font-size:12px;">
  <tr>
    <td>Di transfer ke :<br></td>
    <td colspan="2"></td>
    <td style:"text-align:center">Disetujui oleh :</td>
    <td style:"text-align:center">Penerima :</br>
  </tr>
  <tr>
    <td>Nama Bank : </td>
    <td colspan="2"></td>
    <td rowspan="2" style:"text-align:center"><img src="${TTD_URL}" style="height:60px"></td>
  </tr>
  <tr>
    <td>Atas Nama : </td>
    <td colspan="2"></td>
  </tr>
  <tr>
    <td>Nomor Rekening : </td>
    <td colspan="2"></td>
    <td style:"text-align:center;"><b>Pimpinan</b></td>
    <td style:"text-align:center;">${d.nama_tim}</td>
  </tr>
</table>
`;
openPrev();
}

/* DOWNLOAD */
function download(){
const d=new Date(CUR.tanggal);
const namaFile=
`${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}_${CUR.nama_tim}.jpg`;

html2canvas(slip,{scale:3}).then(c=>{
const a=document.createElement("a");
a.href=c.toDataURL("image/jpeg");
a.download=namaFile;
a.click();
});
}
</script>
</body>
</html>
